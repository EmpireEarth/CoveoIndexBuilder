{
    "title" : "Sorting by dynamic calculated field (distance)",
    "uri" : "http://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "printableUri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "clickUri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "uniqueId" : "42.4247$http://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "excerpt" : "Hello, ... I've got a page that's returning a list of results that have latitude and longitude coordinate associated with them. ... I've also got a long/lat point associated with the user performin...",
    "firstSentences" : null,
    "summary" : null,
    "flags" : "HasHtmlVersion",
    "hasHtmlVersion" : true,
    "hasMobileHtmlVersion" : false,
    "score" : 1105,
    "percentScore" : 74.79931,
    "rankingInfo" : null,
    "rating" : 3.0,
    "isTopResult" : false,
    "isRecommendation" : false,
    "titleHighlights" : [ ],
    "firstSentencesHighlights" : [ ],
    "excerptHighlights" : [ ],
    "printableUriHighlights" : [ ],
    "summaryHighlights" : [ ],
    "parentResult" : null,
    "childResults" : [ ],
    "totalNumberOfChildResults" : 0,
    "raw" : {
      "systitle" : "Sorting by dynamic calculated field (distance)",
      "sysauthor" : "Jeff Hansen",
      "sysurihash" : "f7ZcnOyJAVGðw7HA",
      "urihash" : "f7ZcnOyJAVGðw7HA",
      "numberofanswers" : 0,
      "sysuri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "sysprintableuri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "sitemappriority" : 0.1,
      "systransactionid" : 160352,
      "questionaskeddatestring" : "·\n            May 15, 2015 at 10:16 AM ·",
      "tags" : [ "coveoforsitecore", "sort", "computed", "geospatial", "returntype" ],
      "sysconcepts" : "configuration ; query ; lat ; latitude ; distance ; longitude ; strings ; floating ; explicitly stated ; Sitecore components ; hardcode the sort ; documentation ; InvalidQueryFunctionFieldType ; constantExpression ; advancedExpression ; JavaScript",
      "concepts" : "configuration ; query ; lat ; latitude ; distance ; longitude ; strings ; floating ; explicitly stated ; Sitecore components ; hardcode the sort ; documentation ; InvalidQueryFunctionFieldType ; constantExpression ; advancedExpression ; JavaScript",
      "printableuri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "documenttype" : "WebPage",
      "sysindexeddate" : 1517942129000,
      "permanentid" : "0d0d15794efc44a5f65d5a6d2028486e740e5f8dd3256399b3f98fb74c5a",
      "syslanguage" : [ "English" ],
      "transactionid" : 160352,
      "title" : "Sorting by dynamic calculated field (distance)",
      "date" : 1432080000000,
      "objecttype" : "Answers",
      "sitemapchangefrequency" : "Monthly",
      "hasanswer" : "false",
      "audience" : [ "Administrator", "Developer" ],
      "commentauthor" : [ "Jean-François L'Heureux \u2666\u2666", "Jeff Hansen", "Jeff Hansen", "Wim Nijmeijer", "Jeff Hansen" ],
      "hasacceptedanswer" : "false",
      "sourcetype" : "Sitemap",
      "sysconnectortype" : "SitemapCrawler",
      "rowid" : 5447586,
      "numberofcomments" : 5,
      "size" : 78485,
      "sysdocumenttype" : "WebPage",
      "questionvotes" : 0,
      "clickableuri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "syssource" : "AnswersCloud",
      "orderingid" : 212384744911577885,
      "acceptedanswers" : 0,
      "syssize" : 78485,
      "sysdate" : 1432080000000,
      "author" : "Jeff Hansen",
      "source" : "AnswersCloud",
      "questionbodyhtml" : "<div class=\"question-body\">\n                <p>Hello,</p> \n<p>I've got a page that's returning a list of results that have latitude and longitude coordinate associated with them. I've also got a long/lat point associated with the user performing the query. We've already configured some filtering of results using the Coveo for Sitecore components, such that we're getting back maybe 100 results. Instead of limiting the results, we'd like to simply sort them by the distance from the point associated with the user performing the query. I've got a few questions related to this:</p> \n<ol> \n <li><p> Do the lat/long fields in the index need to be a certain type? They're coming through as String right now. It seems like they'd need to be numeric or floating for the <a rel=\"nofollow\" href=\"https://developers.coveo.com/display/public/SearchREST/Standard+Query+Extensions#StandardQueryExtensions-$qf\">dist function</a> to work, but I've not seen that explicitly stated anywhere. If they do need to be of another type, what return type do I need to set on my computed fields to get those coming through as floating or numeric? Most of the stuff that I've read has been concerned with setting the return type for datetime. </p> </li> \n <li><p> Does the dynamically generated \"distance\" field need to be registered in my configuration files anywhere in order for me to be able to sort on it? </p> </li> \n <li><p> How do I pass the $qf to the JavaScript performing the query to basically hardcode the sort? I've seen a lot about passing the $qf to advancedExpression or constantExpression, but not about how to pass it to sort.</p> </li> \n</ol> \n<p>Here's the excerpt of the code that I'm using:</p> \n<pre><code>  <script type=\"text/javascript\">\n  Coveo.$(function() {\n      CoveoForSitecore.componentsOptions = @(Html.Raw(Model.GetJavaScriptInitializationOptions()));\n \n         // lat/long of user harded for now but will be dynamically retrieved\n       var geoQuery = \"$qf(function:'dist(@Model.ToCoveoFieldName(\"latitude\"), @Model.ToCoveoFieldName(\"longitude\"), 46.8167, -71.2167)', fieldName: 'distance')\";\n       var sort = \"$sort(criteria: 'fieldascending', field: 'distance')\";\n       Coveo.$('#search')\n          .on(\"buildingQuery\", function(e, args) {\n              args.queryBuilder.advancedExpression.add(geoQuery);\n                  //somehow add the sort expression here\n          })\n          .coveoForSitecore('init', CoveoForSitecore.componentsOptions);\n          });\n  </script>\n\n\n</code></pre> \n<p>Here's some additional information about the configuration and code in case someone can help:</p> \n<p>FieldMap:</p> \n<pre><code> <fieldMap type=\"Coveo.Framework.Fields.CoveoFieldMap, Coveo.Framework\">\n         <param desc=\"coveoReflectionFactory\" type=\"Coveo.Framework.Utils.CoveoReflectionFactory, Coveo.Framework\" />\n         <fieldNames hint=\"raw:AddFieldByFieldName\">\n             .....\n           <fieldType fieldName='latitude' settingType='Coveo.Framework.Configuration.FieldConfiguration, Coveo.Framework' returnType=\"System.Double\" />\n           <fieldType fieldName='longitude' settingType='Coveo.Framework.Configuration.FieldConfiguration, Coveo.Framework' returnType=\"System.Double\" />\n         </fieldNames>\n </fieldMap>\n\n</code></pre> \n<p>Computed field definition:</p> \n<pre><code> <fields hint=\"raw:AddComputedIndexField\">\n         ...\n         <field fieldname=\"latitude\">Client.Web.Coveo.ComputedFields.LatitudeComputedField, Client.Web.Coveo</field>\n         <field fieldname=\"longitude\">Client.Web.Coveo.ComputedFields.LongitudeComputedField, Client.Web.Coveo</field>\n    </fields>\n\n</code></pre> \n<p>Code generating the computed field value:</p> \n<pre><code> public class LongitudeComputedField : IComputedIndexField\n {\n     /// <inheritdoc />\n     public string FieldName { get; set; }\n\n     /// <inheritdoc />\n     public string ReturnType { get; set; }\n\n     /// <inheritdoc />\n     public object ComputeFieldValue(IIndexable pIndexable)\n     {\n         Item item = pIndexable as SitecoreIndexableItem;\n\n         if (item == null)\n         {\n             return null;\n         }\n\n         var zipcode = item[\"zip\"] ?? string.Empty;\n\n         if (string.IsNullOrWhiteSpace(zipcode))\n         {\n             return null;\n         }\n\n         var matchingRecord = ZipcodeHelpers.RetrieveZipcodeFromDatabase(zipcode);\n\n         if (matchingRecord == null)\n         {\n             return null;\n         }\n         \n         // the Longitude property is of type \"System.Double\"\n         return matchingRecord.Longitude;\n     }\n }\n</code></pre>\n                </div>",
      "sitemaplastmodified" : 1432080000000,
      "collection" : "default",
      "syssourcetype" : "Sitemap",
      "indexeddate" : 1517942129000,
      "questionnumber" : 4903,
      "connectortype" : "SitemapCrawler",
      "filetype" : "html",
      "sysclickableuri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "sysfiletype" : "html",
      "language" : [ "English" ],
      "sitemapparenturl" : "http://answers.coveo.com/questions/1.xml",
      "questionauthor" : "Jeff Hansen",
      "sitename" : "Answers",
      "sysrowid" : 5447586,
      "uri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
      "syscollection" : "default",
      "sitelanguage" : [ "English" ]
    },
    "Title" : "Sorting by dynamic calculated field (distance)",
    "Uri" : "http://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "PrintableUri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "ClickUri" : "https://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "UniqueId" : "42.4247$http://answers.coveo.com/questions/4903/sorting-by-dynamic-calculated-field-distance.html",
    "Excerpt" : "Hello, ... I've got a page that's returning a list of results that have latitude and longitude coordinate associated with them. ... I've also got a long/lat point associated with the user performin...",
    "FirstSentences" : null
  }