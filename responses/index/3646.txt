{
    "title" : "Configuring a facet with JavaScript in the Pipeline",
    "uri" : "http://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "printableUri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "clickUri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "uniqueId" : "42.4247$http://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "excerpt" : "Our environment is: Coveo index, crawling multiple data sources, including SharePoint, a Salesforce VFP page with a custom UI for the customer facing search interface, using REST (no .NET) to fetch...",
    "firstSentences" : null,
    "summary" : null,
    "flags" : "HasHtmlVersion",
    "hasHtmlVersion" : true,
    "hasMobileHtmlVersion" : false,
    "score" : 1123,
    "percentScore" : 75.406075,
    "rankingInfo" : null,
    "rating" : 3.0,
    "isTopResult" : false,
    "isRecommendation" : false,
    "titleHighlights" : [ ],
    "firstSentencesHighlights" : [ ],
    "excerptHighlights" : [ ],
    "printableUriHighlights" : [ ],
    "summaryHighlights" : [ ],
    "parentResult" : null,
    "childResults" : [ ],
    "totalNumberOfChildResults" : 0,
    "raw" : {
      "systitle" : "Configuring a facet with JavaScript in the Pipeline",
      "sysauthor" : "john vaughan",
      "sysurihash" : "uñNzQ50PDbBWaðNl",
      "urihash" : "uñNzQ50PDbBWaðNl",
      "numberofanswers" : 2,
      "sysuri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "sysprintableuri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "sitemappriority" : 0.1,
      "systransactionid" : 160356,
      "questionaskeddatestring" : "·\n            Jan 18, 2016 at 11:28 AM ·",
      "tags" : [ "facet", "rest", "groupbyresults", "onpostprocessresults" ],
      "sysconcepts" : "target audiences ; Coveo index ; using REST ; UI ; customer ; PostConversion script ; delimited array ; tracing ; JavaScript ; conversion ; rebuilding ; administrator ; onlinehelp",
      "concepts" : "target audiences ; Coveo index ; using REST ; UI ; customer ; PostConversion script ; delimited array ; tracing ; JavaScript ; conversion ; rebuilding ; administrator ; onlinehelp",
      "printableuri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "documenttype" : "WebPage",
      "sysindexeddate" : 1517942466000,
      "permanentid" : "0b83f7fb67ca5a67b027209f637374d96be4e9445f88cb9fdf98a756b09e",
      "syslanguage" : [ "English" ],
      "transactionid" : 160356,
      "title" : "Configuring a facet with JavaScript in the Pipeline",
      "date" : 1454025600000,
      "objecttype" : "Answers",
      "sitemapchangefrequency" : "Monthly",
      "answerauthor" : [ "john vaughan", "Martin Laporte" ],
      "hasanswer" : "true",
      "audience" : [ "Administrator", "Developer" ],
      "commentauthor" : [ "john vaughan", "john vaughan", "Jean-François L'Heureux \u2666\u2666", "john vaughan", "john vaughan" ],
      "hasacceptedanswer" : "true",
      "sourcetype" : "Sitemap",
      "sysconnectortype" : "SitemapCrawler",
      "rowid" : 5448042,
      "numberofcomments" : 5,
      "size" : 91040,
      "sysdocumenttype" : "WebPage",
      "questionvotes" : 0,
      "clickableuri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "syssource" : "AnswersCloud",
      "orderingid" : 212384744911578341,
      "acceptedanswers" : 1,
      "syssize" : 91040,
      "sysdate" : 1454025600000,
      "author" : "john vaughan",
      "source" : "AnswersCloud",
      "questionbodyhtml" : "<div class=\"question-body\">\n                <p>Hi,</p> \n<p>Our environment is: Coveo index, crawling multiple data sources, including SharePoint, a Salesforce VFP page with a custom UI for the customer facing search interface, using REST (no .NET) to fetch the data.</p> \n<p>We were asked to filter SharePoint search results by Target Audience. So, we are indexing the native SharePoint target audience. The field we created in the Coveo index is called <a rel=\"user\" href=\"/users/6004/aeroberb.html\" nodeid=\"6004\">@ae</a>comtargetaudiences. </p> \n<p>Target Audience is a multi-value field. We set up the <a rel=\"user\" href=\"/users/6004/aeroberb.html\" nodeid=\"6004\">@ae</a>comtargetaudiences field as a multi-value facet in the index, and then defined a facet with declarative markup, and it worked. </p> \n<p>However, we discovered that the data for SharePoint target audiences is more complex than just a semicolon delimited string. There are arrays nested in arrays. There is a semicolon delimited array, and inside of that array is nested a comma delimited array. We are only interested in the first section of the data, the first comma delimited array. </p> \n<p>We thought to transform the data in the Pipeline using JavaScript. Therefore I've written JavaScript to parse out the piece that we want, and discard the rest. Then I replace the commas with semicolons, since Coveo facets seem to like semicolons for a delimiter. </p> \n<p>The code looks something like this:</p> \n<pre><code> Coveo.onPostprocessResults(function(results) {\n     var SharePointTargetAudiences = {  \n         // code that parses SharePoint target audience complexity\n     };\n     \n     for ( var rr = 0; rr < results.results.length; rr++){\n         var ta = \"\";\n         if(results.results[rr].fields[\"@aecomtargetaudiences\"]){\n             ta = results.results[rr].fields[\"@aecomtargetaudiences\"];\n         }\n         if(ta){\n             var taraud = SharePointTargetAudiences.parseTargetAudienceData(ta, \"Abbreviated\");\n             if(taraud){\n                 results.results[rr].fields[\"@aecomtargetaudiences\"] = taraud;\n             }\n         }\n     }\n });\n\n</code></pre> \n<p>This seems to run OK inside your DynJS implementation (it blew up until I put in a lot of defensive coding), but it has no effect whatsoever on the <a rel=\"user\" href=\"/users/6004/aeroberb.html\" nodeid=\"6004\">@ae</a>comtargetaudiences field. </p> \n<p>After some research and discussion on the Coveo Support site, I started looking at the groupByResults object. Perhaps I need to create a new Group By field, not indexed but just ad hoc? Something like:</p> \n<pre><code> results.groupByResults.field = \"@aecomtargetaudiencesfacet\"; \n results.groupByResults.Field = \"@aecomtargetaudiencesfacet\"; \n\n</code></pre> \n<p>And from there... create my own groupByResults 'values' data array?</p> \n<pre><code> results.groupByResults.Values = [ \n { \n \"value\" : [\"AUDIENCE TITLE 1\",\"AUDIENCE TITLE 2\"], \n \"lookupValue\" : null, \n \"numberOfResults\" : 1, \n \"score\" : 11184810, \n \"Value\" : \"html\", \n \"LookupValue\" : null, \n \"NumberOfResults\" : 1, \n \"Score\" : 11184810, \n \"computedFieldResults\" : [ ], \n \"ComputedFieldResults\" : [ ] \n }, etc....\n\n</code></pre> \n<p>I could build the value and the numberOfResults, but am unsure how to compute score, or any of the rest of it. I'm unsure if this is the correct approach. Hoping Coveo development can provide some guidance.</p> \n<p>Thanks in advance. :-)</p>\n                </div>",
      "sitemaplastmodified" : 1454025600000,
      "collection" : "default",
      "syssourcetype" : "Sitemap",
      "indexeddate" : 1517942466000,
      "questionnumber" : 7166,
      "connectortype" : "SitemapCrawler",
      "filetype" : "html",
      "sysclickableuri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "sysfiletype" : "html",
      "language" : [ "English" ],
      "sitemapparenturl" : "http://answers.coveo.com/questions/1.xml",
      "questionauthor" : "john vaughan",
      "sitename" : "Answers",
      "sysrowid" : 5448042,
      "uri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
      "syscollection" : "default",
      "sitelanguage" : [ "English" ]
    },
    "Title" : "Configuring a facet with JavaScript in the Pipeline",
    "Uri" : "http://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "PrintableUri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "ClickUri" : "https://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "UniqueId" : "42.4247$http://answers.coveo.com/questions/7166/configuring-a-facet-with-javascript-in-the-pipelin.html",
    "Excerpt" : "Our environment is: Coveo index, crawling multiple data sources, including SharePoint, a Salesforce VFP page with a custom UI for the customer facing search interface, using REST (no .NET) to fetch...",
    "FirstSentences" : null
  }